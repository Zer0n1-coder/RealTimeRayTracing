# 26.5 去噪
使用蒙特卡洛路径追踪算法进行渲染会产生带有不希望出现的噪声图片，如图26.6所示。去噪算法的目的是提取有噪声的图像和选择性辅助图像数据，生成尽可能接近真实情况的新图像。在本节种，我们以非正式的方式使用“相似”一次，因为稍微模糊的图像区域可能比有噪声的图像区域更好。去噪对于实时光线追踪特别重要，因为我们通常只能为每个像素提供少量光线，这意味着渲染图像可能会产生噪声。例如，图26.22中的PICA-PICA图像使用了大约每像素2.25根光线进行的渲染。去噪原理如图26.18所示。由于可以在去噪器中添加反馈回调，如图所示，***temporal antialiasing***可被视为一种基本的去噪算法。大多数（即使不是全部）去噪技术都可以简单地表示为当前像素周围颜色的加权平均值，我们将其枚举为标量值*p*。加权平均值为[公式]，其中dp是像素p的去噪颜色值，cq是当前像素（包括p）周围的噪声颜色值，w(p,q)是加权函数。在这个公式中，在p附近有n个像素，称为N，这个区域通常是正方形。还可以扩展加权函数，以便它使用来自前一帧的信息，例如w(p,p-1,q,q-1)，其中下标-1表示来自该帧的信息。例如，如果需要，加权函数可以访问法线向量nq和先前的颜色值cp-1。去噪示例见图24.2、24.3、26.19、26.20和26.21。  
在基于光线追踪算法的真实感实时渲染中，去噪是一个重要的研究课题。在本节中，我们将简要概述一些重要的工作，并介绍一些可能有用的关键概念。我们参考Zwicker等人的调查[97]。作为了解更多信息的最佳起点。下一步，我们将重点放在地采样数的算法和技巧上，也就是说，每像素只有一个或几个采样。  
为了创建一个无噪声的渲染集(第20章)，通常需要渲染一个G缓冲区(第20章)，这些缓冲数据可作为去噪的辅助图像数据[13,69,76]。例如，光线追踪可用于生成***noisy shadows***、***glossy reflections***和***indirect illumination***。一些方法使用的另一个技巧是将直接光照和间接光照分开，并分别对它们进行去噪处理，因为它们具有不同的属性，例如，间接光照通常是相当平滑的。为了增加去噪过程中使用的样本数量，通常还包括某种时间累积或时间抗锯齿(第5.4.2节)。另一个很好的近似方法是过滤有时被称为***untextured illumination***或者灯光和纹理分离[96]。为了解释这是如何执行的，回想一下渲染方程(11.2)。为了简单起见，省略了物体本身的光线发射项Le。我们只处理漫反射项，尽管类似的过程也可以应用于其他术语。接下来，计算反射项R，它本质上只是漫反射着色项乘以纹理颜色(在表面纹理化的情况下)。无纹理的光照U则是[公式]。纹理项已经被分开了，所以U应该主要包含光照。因此，渲染器可以计算出渲染方程，并执行纹理查找和漫反射着色以获得R，这给了我们***untextured illumination***。该项可以去噪，比如说D，最后的着色值就约等于DR。这避免了在去噪算法中处理纹理，这是有利的，因为纹理通常包含高频内容，例如边缘。***untextured illumination***技巧也类似于Heitz等人[35]。当他们将最终图像分割成一个噪声阴影项和区域光的分析着色时，对阴影项进行去噪，最后重新组合图像。这种类型的分裂通常被称为***ratio estimator***。  
软阴影去噪可以使用***spatio-temporal variance-guided filtering***(SVGF)[69]来完成，SEED[76]使用了该方法。见图26.19.SVGF最初是为使用路径追踪对每像素一个采样的图像进行去噪而开发的，即使用G缓冲区为主要可见性，然后再第一次和第二次命中时使用***temporal accumulation***(第5.4.2节)来增加有效采样数，以及***spatial multi-pass blur***[16,29]其中模糊核大小由噪声数据的方差估计确定。  
可以使用以下技术来增加更多的样本数，即增加方差。首先，平方差之和计算如下：。式中Xs是前n个数字的平均值。方差是__。现在，假设我们已经通过x1……xn计算了sn，并且得到了又一个样本xn+1，我们想把它包括在方差计算中。然后求和使用如下公式进行更新。在这之后，sn+1可以使用方程26.8计算σ2。在SVGF中，类似这样的方法用于估计随时间变化的方差，但是如果检测到不一致，则会转换为使用空间估计，这使得时间方差不可靠。对于软阴影，Llamas和Liu[51,52]使用可分离的横向滤波器（第12.1.1节），其中滤波器权重和半径都是可变的。  
Stachowiak提出了一个用与***denoising reflections***[76]。一些例子如图26.20所示。首先渲染G缓存区，然后从那里发射光线。为了减少追踪的光线数，每2x2个像素仅投射一条反射光线和一条阴影光线。然而，图像的重建仍然是在全分辨率下进行的。反射光线是随机的和重要性采样。“随机”意味着，随着更多随机生成的光线被添加，最终解会收敛到正确的结果。“重要性采样”是指光线朝着对最终结果更有用的方向发送，例如，朝向BRDF的峰值。然后使用类似于屏幕空间反射[75]（第11.6.5节）中使用的方法对图像进行滤波，并同时对图像进行上采样以获得完整的图像分辨率。这个滤波器也是一个比率估计器[35]。这项技术结合时间积累，一个双边清理通道，以及TAA。Llamas和Liu[51,52]提出了一种基于各向异性滤波器核的不同的反射解决方案。  

