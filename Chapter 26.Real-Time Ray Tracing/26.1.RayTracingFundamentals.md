# 26.1 光线追踪基础
&emsp;&emsp;回忆一下方程22.1，其中光线被定义为
$$\overrightarrow {q}(t) = \overrightarrow {o} + t\overrightarrow {d},$$
其中$\overrightarrow {o}$是光线原点，$\overrightarrow {d}$是单位化后的光线方向，t是沿光线方向的距离。请注意，我们在这里使用$\overrightarrow {q}$而不是$\overrightarrow {r}$是为了区分接下来会使用到的右向量$\overrightarrow {r}$。光线追踪可以用***trace***()和***shade***()两个函数来进行描述。其核心的几何算法位于***trace***()中，***trace***()负责查找光线与场景中的片元之间最近的交点，并通过调用***shader***()返回光线的颜色。大多数情况下，我们都想找到一个t>0相交测试结果。对于构造实体几何(constructive solid geometry)，我们通常也需要负距离的交点(位于光线后面的交点)。  
&emsp;&emsp;为了得到一个像素的颜色，我们会向一个像素发射若干条光线，然后计算它们的结果的加权平均值来作为该像素的颜色值。这些光线被称为视线(eye rays)或者相机光线(camera rays)。相机的设置如图26.2所示。给定一个整数像素坐标(x,y)，其中x轴正方向向右，y轴正方向向下，相机位置c，以及坐标框架{$\overrightarrow {r}$,$\overrightarrow {u}$,$\overrightarrow {v}$}(right,up和view)，对于相机，屏幕分辨率为wxh,则计算出的视线方程$\overrightarrow {q}(t) = \overrightarrow {o} + t\overrightarrow {d}$为
$$\overrightarrow {o} = \overrightarrow {c},$$
$$\overrightarrow {s}(x,y) = af(\frac {2(x + 0.5)}{w} - 1)\overrightarrow {r} + f(\frac {2(y + 0.5)}{h} - 1)\overrightarrow {u} +\overrightarrow {v},$$
$$\overrightarrow {d}(x,y) = \frac {\overrightarrow {s}(x,y)}{||\overrightarrow {s}(x,y)||}$$
&emsp;&emsp;其中，单位化的光线方向向量$\overrightarrow {d}$受$f = tan(\frac {\phi}{2})$的影响，$\phi$是相机的竖向视野，$a = w/h$是纵横比。请注意，相机坐标系为左手坐标系，即$\overrightarrow {r}$指向右侧，$\overrightarrow {u}$为上向量，$\overrightarrow {v}$指向由相机到图像平面的方向，即与图4.5所示的设置相似。注意，$\overrightarrow {s}$是一个临时向量，用于单位化$\overrightarrow {d}$。在整数(x,y)位置处加上0.5得到每个像素的中心位置，因为(0.5,0.5)是浮点中心(floating-point center)。如果我们想在要在一个像素中的任何地方发射光线，我们将使用浮点值来表示像素的位置，而不必添加0.5的偏移量。
